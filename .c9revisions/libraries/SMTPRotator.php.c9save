{"ts":1362328556590,"silentsave":true,"restoring":false,"patch":[[]],"length":0}
{"contributors":[],"silentsave":true,"ts":1362328558856,"patch":[[{"diffs":[[1,"<?php\n/**\n * Multi SMTP Rotator\n *\n * Codeigniter Library for use to send email from\n * multiple SMTP account. Each message use only one\n * SMTP account.\n */\n\n/**\n * SMTPRotator Class\n *\n * Codeigniter Library for use to send email from\n * multiple SMTP account. Each message use only one\n * SMTP account.\n * @property SMTPRotator $apungmailer\n */\nclass SMTPRotator\n{\n\n    var $host = array();\n    var $port = array();\n    var $user = array();\n    var $pass = array();\n    var $security = array();\n    var $tablename = 'smtp_servers';\n    var $daily_limit = '500';\n    var $version = '0.0.1';\n\n    /**\n     * SMTPRotator constuctor\n     */\n    public function __construct(){\n\n        $this->init();\n        $ci= &get_instance();\n        $ci->load->database();\n    }\n\n    /**\n     * SMTPRotator::getServers()\n     *\n     * Get all smtpservers\n     * @return array\n     */\n    public function getServers(){\n        $ci = &get_instance();\n        $ci->load->database();\n        $query = $ci->db->get($this->tablename);\n        return $query->result_array();\n    }\n\n    /**\n     * SMTPRotator::addServer\n     *\n     * Adding SMTP Server\n     *\n     * @access public\n     * @return void\n     */\n    public function addServer($config){\n        if(isset($config['host'])) {\n            $this->host = $config['host'];\n        } else {\n            die(\"smtp config host must be defined\");\n        }\n        if(isset($config['port'])) $this->port = $config['port'];\n        if(isset($config['user'])) $this->user = $config['user'];\n        if(isset($config['pass'])) $this->pass = $config['pass'];\n        if(isset($config['security'])) $this->security = $config['security'];\n\n        $ci = &get_instance();\n        $ci->load->database();\n        $ci->db->insert($this->tablename, $config);\n\n    }\n\n\n    /**\n     * SMTPRotator::getServer\n     *\n     * Get SMTP Server\n     * @return mixed\n     */\n    public function getServer(){\n        $ci = &get_instance();\n        $ci->load->database();\n        $ci->db->where('count < '.$this->daily_limit);\n        $ci->db->order_by('count');\n        $query = $ci->db->get($this->tablename);\n        return $query->row_array();\n    }\n\n    /**\n     * SMTPRotator::init()\n     * @access protected\n     */\n    protected function init(){\n        $ci = &get_instance();\n        $ci->load->database();\n        if(!$ci->db->table_exists($this->tablename)){\n            $this->_createTable();\n        }\n\n        // table preparation\n        $this->tableprep();\n\n        // get and set from config\n        $ci->config->load('smtp_rotator', TRUE);\n        $this->daily_limit = $ci->config->item('daily_limit', 'smtp_rotator');\n    }\n\n    /**\n     * SMTPRotator::tableprep()\n     * @access protected\n     */\n    protected function tableprep(){\n        $ci = &get_instance();\n        $set = array(\n            'count' => 0,\n            'lastsend'=> date(\"Y-m-d\")\n        );\n        $ci->db->where(\"lastsend != '\".date(\"Y-m-d\").\"'\");\n        $ci->db->update($this->tablename,$set);\n    }\n\n    /**\n     * SMTPRotator::_createTable()\n     * @access protected\n     */\n    protected function _createTable(){\n        $ci = &get_instance();\n        $ci->load->database();\n        $ci->load->dbforge();\n        $fields = array(\n            'smtpid' => array(\n                'type' => 'INT',\n                'constraint' => 5,\n                'unsigned' => TRUE,\n                'auto_increment' => TRUE\n            ),\n            'host' => array(\n                'type' => 'VARCHAR',\n                'constraint' => '100',\n            ),\n            'port' => array(\n                'type' =>'VARCHAR',\n                'constraint' => '100',\n                'default' => '25',\n            ),\n            'user' => array(\n                'type' => 'VARCHAR',\n                'constraint' => '100',\n            ),\n            'pass' => array(\n                'type'=>'VARCHAR',\n                'constraint' => '100',\n            ),\n            'security' => array(\n                'type'=>'VARCHAR',\n                'constraint'=>'10'\n            ),\n            'lastsend'=>array(\n                'type'=>'DATE',\n                'null'=>TRUE\n            ),\n            'count'=>array(\n                'type'=>'TINYINT',\n                'constraint'=>'4',\n                'default'=>'0'\n            )\n        );\n\n        $ci->dbforge->add_key('smtpid', TRUE);\n        $ci->dbforge->add_field($fields);\n        $ci->dbforge->create_table($this->tablename, TRUE);\n    }\n\n    /**\n     * SMTPRotator::version\n     *\n     * @return version\n     */\n    public function version(){\n        return $this->version;\n    }\n}\n"]],"start1":0,"start2":0,"length1":0,"length2":4621}]],"length":4621,"saved":false}
